<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Electricity Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #f4f6f8;
      --card: #ffffff;
      --primary: #2563eb;
      --text: #1f2937;
      --muted: #6b7280;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    header {
      padding: 1rem 1.5rem;
      background: var(--card);
      border-bottom: 1px solid #e5e7eb;
    }

    header h1 {
      margin: 0;
      font-size: 1.4rem;
    }

    main {
      padding: 1.5rem;
      display: grid;
      gap: 1.5rem;
    }

    /* KPI cards */
    .kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
    }

    .card {
      background: var(--card);
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .card h3 {
      margin: 0;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .card p {
      margin: 0.4rem 0 0;
      font-size: 1.4rem;
      font-weight: 600;
    }

    /* Controls */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }

    select {
      padding: 0.5rem 0.75rem;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #d1d5db;
    }

    /* Charts & table */
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    @media (min-width: 900px) {
      .grid {
        grid-template-columns: 2fr 1fr;
      }
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th, td {
      padding: 0.5rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: right;
    }

    th:first-child,
    td:first-child {
      text-align: left;
    }

    th {
      background: #f9fafb;
    }
  </style>
</head>
<body>

<header>
  <h1>⚡ Electricity Consumption Dashboard</h1>
</header>

<main>
  <!-- KPI section -->
  <section class="kpis">
    <div class="card">
      <h3>Total Users</h3>
      <p id="totalUsers">–</p>
    </div>
    <div class="card">
      <h3>Total Usage (kWh)</h3>
      <p id="totalUsage">–</p>
    </div>
    <div class="card">
      <h3>Selected Province</h3>
      <p id="provinceName">All</p>
    </div>
  </section>

  <!-- Controls -->
  <section class="controls">
    <label>
      Province:
      <select id="provinceSelect"></select>
    </label>
  </section>

  <!-- Charts + Table -->
  <section class="grid">
    <div class="card">
      <canvas id="usageChart" height="140"></canvas>
    </div>

    <div class="card">
      <table id="dataTable">
        <thead>
          <tr>
            <th>Category</th>
            <th>Users</th>
            <th>kWh</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<script>
  const USER_FILE = "electricity_users_en.json";
  const USAGE_FILE = "electricity_usages_en.json";

  const categories = [
    "residential",
    "small_business",
    "medium_business",
    "large_business",
    "specialized_business",
    "public_electricity",
    "temporary_electricity",
    "ev_charging"
  ];

  let usersData = [];
  let usageData = [];
  let chart;

  Promise.all([
    fetch(USER_FILE).then(r => r.json()),
    fetch(USAGE_FILE).then(r => r.json())
  ]).then(([users, usage]) => {
    usersData = users;
    usageData = usage.Sheet1;

    initProvinceSelector();
    updateDashboard("ALL");
  });

  function initProvinceSelector() {
    const select = document.getElementById("provinceSelect");
    select.innerHTML = `<option value="ALL">All Provinces</option>`;

    usersData.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.province_code;
      opt.textContent = p.province_name;
      select.appendChild(opt);
    });

    select.addEventListener("change", e => {
      updateDashboard(e.target.value);
    });
  }

  function updateDashboard(provinceCode) {
    const userRows = provinceCode === "ALL"
      ? usersData
      : usersData.filter(p => p.province_code == provinceCode);

    const usageRows = provinceCode === "ALL"
      ? usageData
      : usageData.filter(p => p.province_code == provinceCode);

    const totals = {};
    categories.forEach(c => totals[c] = { users: 0, kwh: 0 });

    userRows.forEach(r => {
      categories.forEach(c => {
        totals[c].users += r[`${c}_count`] || 0;
      });
    });

    usageRows.forEach(r => {
      categories.forEach(c => {
        totals[c].kwh += r[`${c}_kwh`] || 0;
      });
    });

    // KPI
    document.getElementById("totalUsers").textContent =
      Object.values(totals).reduce((a, b) => a + b.users, 0).toLocaleString();

    document.getElementById("totalUsage").textContent =
      Object.values(totals).reduce((a, b) => a + b.kwh, 0)
        .toLocaleString() + " kWh";

    document.getElementById("provinceName").textContent =
      provinceCode === "ALL"
        ? "All Provinces"
        : userRows[0].province_name;

    updateChart(totals);
    updateTable(totals);
  }

  function updateChart(totals) {
    const maxCategory = categories.reduce((max, c) => totals[c].kwh > totals[max].kwh ? c : max
    );

    const ctx = document.getElementById("usageChart");

    const data = categories.map(c => totals[c].kwh);

    const colors = categories.map(c =>
    c === maxCategory ? "#dc2626" : "#2563eb" // red for max
    );


    if (chart) chart.destroy();

    chart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: categories.map(c => c.replace("_", " ")),
        datasets: [{
        label: "Electricity Usage (kWh)",
        data,
        backgroundColor: colors
        }]

      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } }
      }
    });
  }

  function updateTable(totals) {
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";

    categories.forEach(c => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${c.replace("_", " ")}</td>
        <td>${totals[c].users.toLocaleString()}</td>
        <td>${totals[c].kwh.toLocaleString()}</td>
      `;
      tbody.appendChild(tr);
    });
  }
</script>

</body>
</html>
