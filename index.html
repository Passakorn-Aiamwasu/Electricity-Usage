<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Electricity Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
  <h1>⚡ Electricity Consumption Dashboard</h1>
</header>

<main>
  <!-- KPI section -->
  <section class="kpis">
    <div class="card">
      <h3>Total Users</h3>
      <p id="totalUsers">–</p>
    </div>
    <div class="card">
      <h3>Total Usage (kWh)</h3>
      <p id="totalUsage">–</p>
    </div>
    <div class="card">
      <h3>Selected Province</h3>
      <p id="provinceName">All</p>
    </div>
  </section>

  <!-- Controls -->
  <section class="controls">
    <label>
      Province:
      <select id="provinceSelect"></select>
    </label>
    <label>
        Year:
        <select id="yearSelect"></select>
      </label>      
  </section>

  <!-- Charts + Table -->
  <section class="grid">
    <div class="card">
      <canvas id="usageChart" height="140"></canvas>
    </div>
    <div class="card">
        <canvas id="usagePieChart" height="200"></canvas>
    <div class="card">
            <h3>Total Electricity Usage Forecast</h3>
            <canvas id="forecastChart" height="160"></canvas>
    </div>
          
    </div>
      

    <div class="card">
      <table id="dataTable">
        <thead>
          <tr>
            <th>Category</th>
            <th>Users</th>
            <th>kWh</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<script>
    let forecastChart;
    let pieChart;
  const USER_FILE = "electricity_users_en.json";
  const USAGE_FILE = "electricity_usages_en.json";
    let availableYears = [];
    let selectedYear;

  const categories = [
    "residential",
    "small_business",
    "medium_business",
    "large_business",
    "specialized_business",
    "public_electricity",
    "temporary_electricity",
    "ev_charging"
  ];

  let usersData = [];
  let usageData = [];
  let chart;

  Promise.all([
    fetch(USER_FILE).then(r => r.json()),
    fetch(USAGE_FILE).then(r => r.json())
  ]).then(([users, usage]) => {
    usersData = users;
    usageData = usage.Sheet1;
    availableYears = [...new Set(usageData.map(r => r.year))]
  .sort((a, b) => b - a);

    initYearSelector();


    initProvinceSelector();
    updateForecastChart();
    updateDashboard("ALL");
  });

  function getTotalUsageByYear() {
  const yearlyTotals = {};

  usageData.forEach(r => {
    const y = r.year;
    if (!yearlyTotals[y]) yearlyTotals[y] = 0;

    categories.forEach(c => {
      yearlyTotals[y] += r[`${c}_kwh`] || 0;
    });
  });

  return Object.entries(yearlyTotals)
    .map(([year, total]) => ({ year: Number(year), total }))
    .sort((a, b) => a.year - b.year);
}

function linearRegression(data) {
  const n = data.length;

  const sumX = data.reduce((a, d) => a + d.year, 0);
  const sumY = data.reduce((a, d) => a + d.total, 0);
  const sumXY = data.reduce((a, d) => a + d.year * d.total, 0);
  const sumX2 = data.reduce((a, d) => a + d.year * d.year, 0);

  const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
  const intercept = (sumY - slope * sumX) / n;

  return { slope, intercept };
}

function predictFuture(data, yearsAhead = 3) {
  const { slope, intercept } = linearRegression(data);
  const lastYear = data[data.length - 1].year;

  const future = [];
  for (let i = 1; i <= yearsAhead; i++) {
    const year = lastYear + i;
    future.push({
      year,
      total: Math.round(slope * year + intercept)
    });
  }

  return future;
}

function updateForecastChart() {
  const historical = getTotalUsageByYear();
  const predicted = predictFuture(historical, 3);

  const labels = [
    ...historical.map(d => d.year),
    ...predicted.map(d => d.year)
  ];

  const historicalData = historical.map(d => d.total);
  const predictedData = [
    ...Array(historical.length).fill(null),
    ...predicted.map(d => d.total)
  ];

  const ctx = document.getElementById("forecastChart");

  if (forecastChart) forecastChart.destroy();

  forecastChart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "Actual Usage",
          data: historicalData,
          borderWidth: 2,
          tension: 0.3
        },
        {
          label: "Predicted Usage",
          data: predictedData,
          borderDash: [5, 5],
          borderWidth: 2,
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        tooltip: {
          callbacks: {
            label: ctx =>
              `${ctx.dataset.label}: ${ctx.raw.toLocaleString()} kWh`
          }
        }
      }
    }
  });
}


  function initYearSelector() {
  const select = document.getElementById("yearSelect");

  select.innerHTML = "";

  availableYears.forEach(y => {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    select.appendChild(opt);
  });

  // Default = latest year
  selectedYear = availableYears[0];
  select.value = selectedYear;

  select.addEventListener("change", e => {
    selectedYear = e.target.value;
    updateDashboard(
      document.getElementById("provinceSelect").value
    );
  });
}

  function initProvinceSelector() {
    const select = document.getElementById("provinceSelect");
    select.innerHTML = `<option value="ALL">All Provinces</option>`;

    usersData.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.province_code;
      opt.textContent = p.province_name;
      select.appendChild(opt);
    });

    select.addEventListener("change", e => {
      updateDashboard(e.target.value);
    });
  }

  function updateDashboard(provinceCode) {
    const userRows = provinceCode === "ALL"
      ? usersData
      : usersData.filter(p => p.province_code == provinceCode);

      let usageRows = usageData;

// filter by province
if (provinceCode !== "ALL") {
  usageRows = usageRows.filter(r => r.province_code == provinceCode);
}

// filter by year
usageRows = usageRows.filter(r => r.year == selectedYear);


    const totals = {};
    categories.forEach(c => totals[c] = { users: 0, kwh: 0 });

    userRows.forEach(r => {
      categories.forEach(c => {
        totals[c].users += r[`${c}_count`] || 0;
      });
    });

    usageRows.forEach(r => {
      categories.forEach(c => {
        totals[c].kwh += r[`${c}_kwh`] || 0;
      });
    });

    // KPI
    document.getElementById("totalUsers").textContent =
      Object.values(totals).reduce((a, b) => a + b.users, 0).toLocaleString();

    document.getElementById("totalUsage").textContent =
      Object.values(totals).reduce((a, b) => a + b.kwh, 0)
        .toLocaleString() + " kWh";

    document.getElementById("provinceName").textContent =
      provinceCode === "ALL"
        ? "All Provinces"
        : userRows[0].province_name;

    updateChart(totals);
    updatePieChart(totals);
    updateTable(totals);
  }

  function updateChart(totals) {
    const maxCategory = categories.reduce((max, c) => totals[c].kwh > totals[max].kwh ? c : max
    );

    const ctx = document.getElementById("usageChart");

    const data = categories.map(c => totals[c].kwh);

    const colors = categories.map(c =>
    c === maxCategory ? "#dc2626" : "#2563eb" // red for max
    );


    if (chart) chart.destroy();

    chart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: categories.map(c => c.replace("_", " ")),
        datasets: [{
        label: "Electricity Usage (kWh)",
        data,
        backgroundColor: colors
        }]

      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } }
      }
    });
  }

  function updatePieChart(totals) {
  const ctx = document.getElementById("usagePieChart");

  const values = categories.map(c => totals[c].kwh);
  const totalKwh = values.reduce((a, b) => a + b, 0);

  const maxCategory = categories.reduce((max, c) =>
    totals[c].kwh > totals[max].kwh ? c : max
  );

  const colors = categories.map(c =>
    c === maxCategory ? "#dc2626" : "#60a5fa"
  );

  if (pieChart) pieChart.destroy();

  pieChart = new Chart(ctx, {
    type: "pie",
    data: {
      labels: categories.map(c => c.replace("_", " ")),
      datasets: [{
        data: values,
        backgroundColor: colors
      }]
    },
    options: {
      responsive: true,
      plugins: {
        tooltip: {
          callbacks: {
            label: ctx => {
              const value = ctx.raw;
              const percent = ((value / totalKwh) * 100).toFixed(1);
              return `${ctx.label}: ${percent}% (${value.toLocaleString()} kWh)`;
            }
          }
        },
        legend: {
          position: "bottom"
        }
      }
    }
  });
}


  function updateTable(totals) {
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";

    categories.forEach(c => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${c.replace("_", " ")}</td>
        <td>${totals[c].users.toLocaleString()}</td>
        <td>${totals[c].kwh.toLocaleString()}</td>
      `;
      tbody.appendChild(tr);
    });
  }
</script>

</body>
</html>
